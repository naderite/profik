{"version":3,"names":["_react","require","_core","_commonTypes","_threads","initSensorData","sensorType","SensorType","ROTATION","makeMutable","qw","qx","qy","qz","yaw","pitch","roll","interfaceOrientation","x","y","z","eulerToQuaternion","c1","Math","cos","s1","sin","c2","s2","c3","s3","adjustRotationToInterfaceOrientation","data","PI","q","adjustVectorToInterfaceOrientation","useAnimatedSensor","userConfig","ref","useRef","sensor","unregister","isAvailable","config","interval","adjustToInterfaceOrientation","iosReferenceFrame","IOSReferenceFrame","Auto","useEffect","current","sensorData","id","registerSensor","value","callMicrotasks","unregisterSensor"],"sources":["useAnimatedSensor.ts"],"sourcesContent":["import { useEffect, useRef } from 'react';\nimport { makeMutable, registerSensor, unregisterSensor } from '../core';\nimport {\n  SensorType,\n  SharedValue,\n  Value3D,\n  ValueRotation,\n  IOSReferenceFrame,\n} from '../commonTypes';\nimport { callMicrotasks } from '../threads';\n\nexport type SensorConfig = {\n  interval: number | 'auto';\n  adjustToInterfaceOrientation: boolean;\n  iosReferenceFrame: IOSReferenceFrame;\n};\n\nexport type AnimatedSensor = {\n  sensor: SharedValue<Value3D | ValueRotation>;\n  unregister: () => void;\n  isAvailable: boolean;\n  config: SensorConfig;\n};\n\nfunction initSensorData(\n  sensorType: SensorType\n): SharedValue<Value3D | ValueRotation> {\n  if (sensorType === SensorType.ROTATION) {\n    return makeMutable<Value3D | ValueRotation>({\n      qw: 0,\n      qx: 0,\n      qy: 0,\n      qz: 0,\n      yaw: 0,\n      pitch: 0,\n      roll: 0,\n      interfaceOrientation: 0,\n    });\n  } else {\n    return makeMutable<Value3D | ValueRotation>({\n      x: 0,\n      y: 0,\n      z: 0,\n      interfaceOrientation: 0,\n    });\n  }\n}\n\n// euler angles are in order ZXY, z = yaw, x = pitch, y = roll\n// https://github.com/mrdoob/three.js/blob/dev/src/math/Quaternion.js#L237\nfunction eulerToQuaternion(pitch: number, roll: number, yaw: number) {\n  'worklet';\n  const c1 = Math.cos(pitch / 2);\n  const s1 = Math.sin(pitch / 2);\n  const c2 = Math.cos(roll / 2);\n  const s2 = Math.sin(roll / 2);\n  const c3 = Math.cos(yaw / 2);\n  const s3 = Math.sin(yaw / 2);\n\n  return [\n    s1 * c2 * c3 - c1 * s2 * s3,\n    c1 * s2 * c3 + s1 * c2 * s3,\n    c1 * c2 * s3 + s1 * s2 * c3,\n    c1 * c2 * c3 - s1 * s2 * s3,\n  ];\n}\n\nfunction adjustRotationToInterfaceOrientation(data: ValueRotation) {\n  'worklet';\n  const { interfaceOrientation, pitch, roll, yaw } = data;\n  if (interfaceOrientation === 90) {\n    data.pitch = roll;\n    data.roll = -pitch;\n    data.yaw = yaw - Math.PI / 2;\n  } else if (interfaceOrientation === 270) {\n    data.pitch = -roll;\n    data.roll = pitch;\n    data.yaw = yaw + Math.PI / 2;\n  } else if (interfaceOrientation === 180) {\n    data.pitch *= -1;\n    data.roll *= -1;\n    data.yaw *= -1;\n  }\n\n  const q = eulerToQuaternion(data.pitch, data.roll, data.yaw);\n  data.qx = q[0];\n  data.qy = q[1];\n  data.qz = q[2];\n  data.qw = q[3];\n  return data;\n}\n\nfunction adjustVectorToInterfaceOrientation(data: Value3D) {\n  'worklet';\n  const { interfaceOrientation, x, y } = data;\n  if (interfaceOrientation === 90) {\n    data.x = -y;\n    data.y = x;\n  } else if (interfaceOrientation === 270) {\n    data.x = y;\n    data.y = -x;\n  } else if (interfaceOrientation === 180) {\n    data.x *= -1;\n    data.y *= -1;\n  }\n  return data;\n}\n\nexport function useAnimatedSensor(\n  sensorType: SensorType,\n  userConfig?: Partial<SensorConfig>\n): AnimatedSensor {\n  const ref = useRef<AnimatedSensor>({\n    sensor: initSensorData(sensorType),\n    unregister: () => {\n      // NOOP\n    },\n    isAvailable: false,\n    config: {\n      interval: 0,\n      adjustToInterfaceOrientation: true,\n      iosReferenceFrame: IOSReferenceFrame.Auto,\n    },\n  });\n\n  useEffect(() => {\n    ref.current.config = {\n      interval: 'auto',\n      adjustToInterfaceOrientation: true,\n      iosReferenceFrame: IOSReferenceFrame.Auto,\n      ...userConfig,\n    };\n    const sensorData = ref.current.sensor!;\n    const id = registerSensor(\n      sensorType,\n      ref.current.config.interval === 'auto' ? -1 : ref.current.config.interval,\n      ref.current.config.iosReferenceFrame,\n      (data) => {\n        'worklet';\n        if (ref.current.config.adjustToInterfaceOrientation) {\n          if (sensorType === SensorType.ROTATION) {\n            data = adjustRotationToInterfaceOrientation(data as ValueRotation);\n          } else {\n            data = adjustVectorToInterfaceOrientation(data as Value3D);\n          }\n        }\n        sensorData.value = data;\n        callMicrotasks();\n      }\n    );\n\n    if (id !== -1) {\n      // if sensor is available\n      ref.current.unregister = () => unregisterSensor(id);\n      ref.current.isAvailable = true;\n    } else {\n      // if sensor is unavailable\n      ref.current.unregister = () => {\n        // NOOP\n      };\n      ref.current.isAvailable = false;\n    }\n\n    return () => {\n      ref.current.unregister();\n    };\n  }, [sensorType, userConfig]);\n\n  return ref.current;\n}\n"],"mappings":";;;;;;AAAA,IAAAA,MAAA,GAAAC,OAAA;AACA,IAAAC,KAAA,GAAAD,OAAA;AACA,IAAAE,YAAA,GAAAF,OAAA;AAOA,IAAAG,QAAA,GAAAH,OAAA;AAeA,SAASI,cAAcA,CACrBC,UAAsB,EACgB;EACtC,IAAIA,UAAU,KAAKC,uBAAU,CAACC,QAAQ,EAAE;IACtC,OAAO,IAAAC,iBAAW,EAA0B;MAC1CC,EAAE,EAAE,CAAC;MACLC,EAAE,EAAE,CAAC;MACLC,EAAE,EAAE,CAAC;MACLC,EAAE,EAAE,CAAC;MACLC,GAAG,EAAE,CAAC;MACNC,KAAK,EAAE,CAAC;MACRC,IAAI,EAAE,CAAC;MACPC,oBAAoB,EAAE;IACxB,CAAC,CAAC;EACJ,CAAC,MAAM;IACL,OAAO,IAAAR,iBAAW,EAA0B;MAC1CS,CAAC,EAAE,CAAC;MACJC,CAAC,EAAE,CAAC;MACJC,CAAC,EAAE,CAAC;MACJH,oBAAoB,EAAE;IACxB,CAAC,CAAC;EACJ;AACF;;AAEA;AACA;AACA,SAASI,iBAAiBA,CAACN,KAAa,EAAEC,IAAY,EAAEF,GAAW,EAAE;EACnE,SAAS;;EACT,MAAMQ,EAAE,GAAGC,IAAI,CAACC,GAAG,CAACT,KAAK,GAAG,CAAC,CAAC;EAC9B,MAAMU,EAAE,GAAGF,IAAI,CAACG,GAAG,CAACX,KAAK,GAAG,CAAC,CAAC;EAC9B,MAAMY,EAAE,GAAGJ,IAAI,CAACC,GAAG,CAACR,IAAI,GAAG,CAAC,CAAC;EAC7B,MAAMY,EAAE,GAAGL,IAAI,CAACG,GAAG,CAACV,IAAI,GAAG,CAAC,CAAC;EAC7B,MAAMa,EAAE,GAAGN,IAAI,CAACC,GAAG,CAACV,GAAG,GAAG,CAAC,CAAC;EAC5B,MAAMgB,EAAE,GAAGP,IAAI,CAACG,GAAG,CAACZ,GAAG,GAAG,CAAC,CAAC;EAE5B,OAAO,CACLW,EAAE,GAAGE,EAAE,GAAGE,EAAE,GAAGP,EAAE,GAAGM,EAAE,GAAGE,EAAE,EAC3BR,EAAE,GAAGM,EAAE,GAAGC,EAAE,GAAGJ,EAAE,GAAGE,EAAE,GAAGG,EAAE,EAC3BR,EAAE,GAAGK,EAAE,GAAGG,EAAE,GAAGL,EAAE,GAAGG,EAAE,GAAGC,EAAE,EAC3BP,EAAE,GAAGK,EAAE,GAAGE,EAAE,GAAGJ,EAAE,GAAGG,EAAE,GAAGE,EAAE,CAC5B;AACH;AAEA,SAASC,oCAAoCA,CAACC,IAAmB,EAAE;EACjE,SAAS;;EACT,MAAM;IAAEf,oBAAoB;IAAEF,KAAK;IAAEC,IAAI;IAAEF;EAAI,CAAC,GAAGkB,IAAI;EACvD,IAAIf,oBAAoB,KAAK,EAAE,EAAE;IAC/Be,IAAI,CAACjB,KAAK,GAAGC,IAAI;IACjBgB,IAAI,CAAChB,IAAI,GAAG,CAACD,KAAK;IAClBiB,IAAI,CAAClB,GAAG,GAAGA,GAAG,GAAGS,IAAI,CAACU,EAAE,GAAG,CAAC;EAC9B,CAAC,MAAM,IAAIhB,oBAAoB,KAAK,GAAG,EAAE;IACvCe,IAAI,CAACjB,KAAK,GAAG,CAACC,IAAI;IAClBgB,IAAI,CAAChB,IAAI,GAAGD,KAAK;IACjBiB,IAAI,CAAClB,GAAG,GAAGA,GAAG,GAAGS,IAAI,CAACU,EAAE,GAAG,CAAC;EAC9B,CAAC,MAAM,IAAIhB,oBAAoB,KAAK,GAAG,EAAE;IACvCe,IAAI,CAACjB,KAAK,IAAI,CAAC,CAAC;IAChBiB,IAAI,CAAChB,IAAI,IAAI,CAAC,CAAC;IACfgB,IAAI,CAAClB,GAAG,IAAI,CAAC,CAAC;EAChB;EAEA,MAAMoB,CAAC,GAAGb,iBAAiB,CAACW,IAAI,CAACjB,KAAK,EAAEiB,IAAI,CAAChB,IAAI,EAAEgB,IAAI,CAAClB,GAAG,CAAC;EAC5DkB,IAAI,CAACrB,EAAE,GAAGuB,CAAC,CAAC,CAAC,CAAC;EACdF,IAAI,CAACpB,EAAE,GAAGsB,CAAC,CAAC,CAAC,CAAC;EACdF,IAAI,CAACnB,EAAE,GAAGqB,CAAC,CAAC,CAAC,CAAC;EACdF,IAAI,CAACtB,EAAE,GAAGwB,CAAC,CAAC,CAAC,CAAC;EACd,OAAOF,IAAI;AACb;AAEA,SAASG,kCAAkCA,CAACH,IAAa,EAAE;EACzD,SAAS;;EACT,MAAM;IAAEf,oBAAoB;IAAEC,CAAC;IAAEC;EAAE,CAAC,GAAGa,IAAI;EAC3C,IAAIf,oBAAoB,KAAK,EAAE,EAAE;IAC/Be,IAAI,CAACd,CAAC,GAAG,CAACC,CAAC;IACXa,IAAI,CAACb,CAAC,GAAGD,CAAC;EACZ,CAAC,MAAM,IAAID,oBAAoB,KAAK,GAAG,EAAE;IACvCe,IAAI,CAACd,CAAC,GAAGC,CAAC;IACVa,IAAI,CAACb,CAAC,GAAG,CAACD,CAAC;EACb,CAAC,MAAM,IAAID,oBAAoB,KAAK,GAAG,EAAE;IACvCe,IAAI,CAACd,CAAC,IAAI,CAAC,CAAC;IACZc,IAAI,CAACb,CAAC,IAAI,CAAC,CAAC;EACd;EACA,OAAOa,IAAI;AACb;AAEO,SAASI,iBAAiBA,CAC/B9B,UAAsB,EACtB+B,UAAkC,EAClB;EAChB,MAAMC,GAAG,GAAG,IAAAC,aAAM,EAAiB;IACjCC,MAAM,EAAEnC,cAAc,CAACC,UAAU,CAAC;IAClCmC,UAAU,EAAEA,CAAA,KAAM;MAChB;IAAA,CACD;IACDC,WAAW,EAAE,KAAK;IAClBC,MAAM,EAAE;MACNC,QAAQ,EAAE,CAAC;MACXC,4BAA4B,EAAE,IAAI;MAClCC,iBAAiB,EAAEC,8BAAiB,CAACC;IACvC;EACF,CAAC,CAAC;EAEF,IAAAC,gBAAS,EAAC,MAAM;IACdX,GAAG,CAACY,OAAO,CAACP,MAAM,GAAG;MACnBC,QAAQ,EAAE,MAAM;MAChBC,4BAA4B,EAAE,IAAI;MAClCC,iBAAiB,EAAEC,8BAAiB,CAACC,IAAI;MACzC,GAAGX;IACL,CAAC;IACD,MAAMc,UAAU,GAAGb,GAAG,CAACY,OAAO,CAACV,MAAO;IACtC,MAAMY,EAAE,GAAG,IAAAC,oBAAc,EACvB/C,UAAU,EACVgC,GAAG,CAACY,OAAO,CAACP,MAAM,CAACC,QAAQ,KAAK,MAAM,GAAG,CAAC,CAAC,GAAGN,GAAG,CAACY,OAAO,CAACP,MAAM,CAACC,QAAQ,EACzEN,GAAG,CAACY,OAAO,CAACP,MAAM,CAACG,iBAAiB,EACnCd,IAAI,IAAK;MACR,SAAS;;MACT,IAAIM,GAAG,CAACY,OAAO,CAACP,MAAM,CAACE,4BAA4B,EAAE;QACnD,IAAIvC,UAAU,KAAKC,uBAAU,CAACC,QAAQ,EAAE;UACtCwB,IAAI,GAAGD,oCAAoC,CAACC,IAAI,CAAkB;QACpE,CAAC,MAAM;UACLA,IAAI,GAAGG,kCAAkC,CAACH,IAAI,CAAY;QAC5D;MACF;MACAmB,UAAU,CAACG,KAAK,GAAGtB,IAAI;MACvB,IAAAuB,uBAAc,GAAE;IAClB,CAAC,CACF;IAED,IAAIH,EAAE,KAAK,CAAC,CAAC,EAAE;MACb;MACAd,GAAG,CAACY,OAAO,CAACT,UAAU,GAAG,MAAM,IAAAe,sBAAgB,EAACJ,EAAE,CAAC;MACnDd,GAAG,CAACY,OAAO,CAACR,WAAW,GAAG,IAAI;IAChC,CAAC,MAAM;MACL;MACAJ,GAAG,CAACY,OAAO,CAACT,UAAU,GAAG,MAAM;QAC7B;MAAA,CACD;MACDH,GAAG,CAACY,OAAO,CAACR,WAAW,GAAG,KAAK;IACjC;IAEA,OAAO,MAAM;MACXJ,GAAG,CAACY,OAAO,CAACT,UAAU,EAAE;IAC1B,CAAC;EACH,CAAC,EAAE,CAACnC,UAAU,EAAE+B,UAAU,CAAC,CAAC;EAE5B,OAAOC,GAAG,CAACY,OAAO;AACpB"}